# ! KAS_BUILD_DIR=build-rpi4 kas build kas_rpi.yml

header:
  version: 11

# Définition des dépôts à cloner et des layers à activer
repos:
  poky:
    url: "https://git.yoctoproject.org/poky.git"
    refspec: "scarthgap"
    #commit: "e3ce89324da1e33c17c9180ef846f41d92616254"
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    refspec: "scarthgap"
    #commit: "e621da947048842109db1b4fd3917a02e0501aa2"
    layers:
      meta-oe:
      meta-networking:
      meta-python:

  meta-mender-community:
    url: "https://github.com/mendersoftware/meta-mender-community.git"
    refspec: "scarthgap"
    layers:
      meta-mender-raspberrypi:
      # meta-mender-update-modules:
  
  meta-mender:
    url: "https://github.com/mendersoftware/meta-mender.git"
    refspec: "scarthgap"
    #commit: "bff4b64715aae33e5c3a0bf5c804e6a1f4726c1c"
    layers:
      meta-mender-core:

  meta-raspberrypi:
    url: https://github.com/agherzan/meta-raspberrypi.git
    refspec: 1091bde25e9ebaea33114edb85e4aee931d105f3

  meta-lts-mixins-uboot:
    url: https://git.yoctoproject.org/meta-lts-mixins
    refspec: "scarthgap/u-boot"
    path: "meta-lts-mixins"

  meta-secure-core:
    url: "https://github.com/Wind-River/meta-secure-core.git"
    refspec: "scarthgap"
    layers:
      meta-encrypted-storage:
      meta-tpm2:

  # meta-clevis:
  #   url: "https://github.com/ejaaskel/meta-clevis.git"
  #   refspec: "main"


  meta-custom:
    url: "https://github.com/stanleyselvaratnam/meta-custom.git"
    refspec: "main"
    layers:
      meta-hellocustom:
      meta-key:

  meta-imx8mp-rega:
    path: "meta-imx8mp-rega"
    layers:
      meta-local:
      meta-myapps:
      meta-connectivity:
      meta-crypto:
      # meta-wic:
      # meta-rollback:
      # meta-kernel-custom:
  
# Configuration de la build
build_system: oe

target:
  # - u-boot
  - core-image-base

machine: raspberrypi4-64

distro: poky

# Isole les caches par machine
env:
  SSTATE_DIR: "/workdir/build/sstate-${MACHINE}"


# Variables injectées dans conf/local.conf
local_conf_header:
  my-config: |

    # TODO : test the rollback, partition the kernel, double authentification, boot firmware
    # * ================================================================
    # * Local configuration for building core-image-minimal with Mender
    # * ================================================================

    # Inherit the full Mender integration layer
    INHERIT += "mender-full"

    # This really saves a lot of disk space!
    INHERIT += "rm_work"

    # Enable update of firmware files
    # INHERIT += "rpi-update-firmware"
    # ! NOTE! Updating these files is a non-reversible operation

    # * ================================================================
    # * Package management and image features
    # * ================================================================

    # Use IPK as package format
    PACKAGE_CLASSES ?= "package_ipk"

    # Packages to include in the image
    IMAGE_INSTALL:append = " htop vim ca-certificates helloworld hellocustom lsof"

    # * ================================================================
    # * Bootloader configuration
    # * ================================================================

    # U-Boot bootloader files to include in image
    UBOOT_MACHINE = "raspberrypi4_64_defconfig"

    # IMAGE_BOOT_FILES = "u-boot.bin"

    # Init system to use
    INIT_MANAGER = "systemd"
    
    # ! Kernel et DTB
    KERNEL_DEVICETREE = "broadcom/bcm2711-rpi-4-b.dtb"


    # UBOOT_CONFIGURE_ARGS:append = " --disable-efi"

    # ! Install files in /boot pour U-Boot
    IMAGE_INSTALL:append = " kernel-image kernel-devicetree"

    # # Disable EFI-related packages if any
    # # IMAGE_INSTALL:remove = "efi-utils"

    # * ================================================================
    # * ENABLE UART
    # * ================================================================

    RPI_USE_U_BOOT = "1"
    ENABLE_UART = "1"
    RPI_EXTRA_CONFIG += "dtoverlay=disable-bt"
    IMAGE_FSTYPES:remove = " rpi-sdimg"

    # * ================================================================
    # * ENABLE WIFI
    # * ================================================================

    DISTRO_FEATURES:append = " wifi"

    IMAGE_INSTALL:append = " linux-firmware-rpidistro-bcm43455 i2c-tools bridge-utils hostapd iptables dhcpcd wpa-supplicant-wifi iw"
    LICENSE_FLAGS_ACCEPTED += "synaptics-killswitch"

    # * ================================================================
    # * ENABLE SSH
    # * ================================================================

    # Extra image features: debugging tools and SSH server
    EXTRA_IMAGE_FEATURES ?= "ssh-server-openssh"
    IMAGE_INSTALL:append = " ssh-keys"

    INHERIT += "extrausers"
    EXTRA_USERS_PARAMS = "usermod -p '$(openssl passwd -1 password123)' root;"

    # * ================================================================
    # * STATIC HOST MAPPING
    # * ================================================================
    
    IMAGE_INSTALL:append = " hosts"

    # * ================================================================
    # * Image types
    # * ================================================================

    # Build SD card image
    IMAGE_FSTYPES += "sdimg"

    # * ================================================================
    # * Partition with WKS (meta-wic)
    # * ================================================================

    # ! WIC image configuration
    # WKS_FILE = "custom-qemuarm64.wks.in"
    # IMAGE_FSTYPES += "wic wic.bz2"

    # * ================================================================
    # * ENCRYPTION
    # * ================================================================

    # # Packages cryptographiques nécessaires
    # IMAGE_INSTALL:append = " cryptsetup e2fsprogs util-linux"

    # # Active le framework sécurité
    # SECURECORE_ENABLE = "1"

    # # Désactive le TPM (non présent sur ton RPi4)
    # DISTRO_FEATURES:remove = "tpm tpm2"

    # # Si TPM absent, activer mode passphrase-manuelle
    # SECURECORE_STORAGE_ENCRYPTION_METHOD = "manual"

    # # Cible la partition à sécuriser
    # SECURECORE_LUKS_DEVICE = "/dev/mmcblk0p5"
    # SECURECORE_LUKS_LABEL = "securedata"
    # SECURECORE_LUKS_SIZE_MB = "256"

    # # Définit le cryptsetup à utiliser
    # SECURECORE_USE_LUKS2 = "1"


    # * ================================================================
    # * Mender configuration (meta-mender-core)
    # * ================================================================

    # Name of the Mender artifact
    MENDER_ARTIFACT_NAME = "release-test"

    # Mender server URL and tenant token
    # MENDER_SERVER_URL = "https://eu.hosted.mender.io"
    MENDER_SERVER_URL = ""
    MENDER_TENANT_TOKEN = "AVi5j0YkJYNeYRamqwzY2r9WRz3sJo5nbGDGaE0uXtQ"

    # Device type
    MENDER_DEVICE_TYPE = "raspberrypi4-64"

    # Storage device and partition layout
    # ! MENDER_STORAGE_DEVICE = "/dev/vda"
    MENDER_STORAGE_DEVICE = "/dev/mmcblk0"
    MENDER_STORAGE_TOTAL_SIZE_MB = "4096"
    MENDER_BOOT_PART_SIZE_MB = "100"
    MENDER_DATA_PART_SIZE_MB = "128"

    # ! Enable automatic U-Boot configuration for partitions
    MENDER_UBOOT_AUTO_CONFIGURE = "1"

    # Polling intervals (empty = default)
    MENDER_UPDATE_POLL_INTERVAL_SECONDS = ""
    MENDER_INVENTORY_POLL_INTERVAL_SECONDS = ""
    MENDER_RETRY_POLL_INTERVAL_SECONDS = ""

    # --- MENDER SIGNING / VERIFY CONFIGURATION ---

    # Clé publique installée par mender-keys.bb
    IMAGE_INSTALL:append = " mender-keys mender-keys-rotation"

    # Clé privée utilisée pour signer les artifacts (chemin absolu)
    MENDER_ARTIFACT_SIGNING_KEY = "${TOPDIR}/../mender-keys/private.key"

    # Clé publique utilisée pour vérifier les artifacts pendant le build
    # MENDER_ARTIFACT_VERIFY_KEY  = "${TOPDIR}/../mender-keys/public.key"

    # Added the script to update the kernel
    # IMAGE_INSTALL:append = " kernel-update-module"

    IMAGE_INSTALL:append = " mender-artifact-info"

    # MENDER_FEATURES_ENABLE:append = " mender-uboot"
    # MENDER_FEATURES_DISABLE:append = " mender-grub mender-image-uefi"

    # ! ================================================================
    # ! ENCRYPTED PARTITION SETUP
    # ! ================================================================
    # Mender ne doit plus monter /data automatiquement au boot
    MENDER_DATA_MOUNT_DISABLED = "1"

    # (Optionnel) Redéfinis la partition /data sur p4
    MENDER_DATA_PART = "${MENDER_STORAGE_DEVICE_BASE}4"
    
    # Enable GPT partitioning
    MENDER_FEATURES_ENABLE:append = " mender-image-gpt"
    
    # Add secure data partition (unformatted)
    MENDER_EXTRA_PARTS = "securepart"
    MENDER_EXTRA_PARTS[securepart] = "--label=securedata --size=256"
    
    # Install LUKS tools and init script
    IMAGE_INSTALL:append = " cryptsetup e2fsprogs util-linux lsof luks-init"
    
    # Enable systemd service
    SYSTEMD_AUTO_ENABLE:pn-systemd = "enable"

    # Si besoin d’options fstab automatiques
    # MENDER_EXTRA_PARTS_FSTAB[securepart] = "auto defaults 0 2"

    # Pour créer les liens symboliques de la partition chiffrée au rootfs
    IMAGE_INSTALL:append = " secure-symlinks"
    IMAGE_INSTALL:append = " mender-cert"
    # ! ================================================================
    # ! Test Rollback (meta-rollback)
    # ! ================================================================

    # ! Only to test the rollback
    # ! IMAGE_INSTALL:append = " rollback-test"
    
    # ? ================================================================
    # ? Build performance tuning
    # ? ================================================================

    # Limit the number of parallel tasks to avoid memory issues
    BB_NUMBER_THREADS = "10"
    PARALLEL_MAKE = "-j 10"

    # ? ================================================================
    # ? Experimental / commented options
    # ? ================================================================

    # Uncomment to include Mender packages (if using RPM or testing)
    # IMAGE_INSTALL:append = " mender-client mender-auth mender-update"

    # BBMASK examples (to exclude certain recipes)
    # BBMASK += "recipes-mender/mender-client/mender-client_3.5.3.bb"
    # BBMASK += "recipes-mender/mender-client/mender-client_git.bb"
    # Force specific Mender version or provider
    # PREFERRED_VERSION_mender-client = "5.0.2"
    # PREFERRED_VERSION_mender = "5.0.2"
    # PREFERRED_PROVIDER_mender = "mender"

    # Debug prefix map removal
    # DEBUG_PREFIX_MAP:remove = "-fcanon-prefix-map"

    # Kernel device tree configuration
    # KERNEL_DEVICETREE = "qemu.dtb"

    # Bootloader and kernel preferences
    # IMAGE_INSTALL:remove = "grub"
    # UBOOT_MACHINE = "qemu_arm64_defconfig"
    # IMAGE_CLASSES = ""
    # PREFERRED_PROVIDER_virtual/bootloader = "u-boot"
    # PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"

    # Emulator / RTC tools
    # IMAGE_INSTALL:append = " rtc-tools"

    # IMAGE_INSTALL:append = " wpa-supplicant iw"
    # IMAGE_INSTALL:append = " firmware-brcm80211"

    # RPI_KERNEL_MODULE_AUTOLOAD += "brcmfmac cfg80211"



    # IMAGE_INSTALL:append = " brcmfmac-firmware networkmanager-autoconnect networkmanager"

    # IMAGE_INSTALL:append = " kernel-module-brcmfmac kernel-module-cfg80211"